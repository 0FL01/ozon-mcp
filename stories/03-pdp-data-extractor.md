# Story 3: Экстрактор данных карточки товара (Product Detail Page)

## Контекст
Страница карточки товара (PDP) на Ozon содержит огромное количество информации: рекламу, рекомендации, футер, хедер. Передача всего в LLM переполнит контекст. Нужен точечный экстрактор только нужных данных.

## Цель
Создать JavaScript-скрипт для извлечения **всей релевантной информации** о товаре без "мусора".

## Извлекаемые данные

### Основная информация
| Поле                | Тип        | Описание                                    |
|---------------------|------------|---------------------------------------------|
| `sku`               | string     | Артикул товара                              |
| `title`             | string     | Полное название                             |
| `brand`             | string?    | Бренд                                       |
| `availability`      | enum       | "inStock" / "fewLeft" / "outOfStock"        |
| `availabilityText`  | string     | Текст статуса ("В наличии", "Осталось 3")   |

### Цены
| Поле                | Тип        | Описание                                    |
|---------------------|------------|---------------------------------------------|
| `price`             | number     | Текущая цена                                |
| `priceOzonCard`     | number?    | Цена с Ozon Картой                          |
| `priceOriginal`     | number?    | Старая цена                                 |
| `discount`          | number?    | Процент скидки                              |
| `currency`          | string     | Валюта                                      |

### Вариации (КРИТИЧЕСКИ ВАЖНО)
| Поле                | Тип        | Описание                                    |
|---------------------|------------|---------------------------------------------|
| `variations`        | array      | Массив опций (размеры/цвета/объём)          |
| `variations[].type` | string     | Тип: "size" / "color" / "volume"            |
| `variations[].name` | string     | Название опции ("Размер", "Цвет")           |
| `variations[].options` | array   | Доступные значения                          |
| `variations[].options[].value` | string   | Значение ("L", "Красный")          |
| `variations[].options[].status` | enum    | "active" / "selected" / "disabled" |
| `variations[].options[].selector` | string | CSS-селектор для выбора             |

### Характеристики
| Поле                | Тип        | Описание                                    |
|---------------------|------------|---------------------------------------------|
| `specs`             | object     | Ключ-значение характеристик                 |
| `description`       | string?    | Краткое описание (первые 500 символов)      |

### Действия (CTA)
| Поле                | Тип        | Описание                                    |
|---------------------|------------|---------------------------------------------|
| `cta.text`          | string     | Текст главной кнопки                        |
| `cta.enabled`       | boolean    | Кнопка активна?                             |
| `cta.selector`      | string     | CSS-селектор кнопки                         |

### Мета
| Поле                | Тип        | Описание                                    |
|---------------------|------------|---------------------------------------------|
| `canonicalUrl`      | string     | Чистый URL товара                           |
| `imageUrls`         | array      | Массив URL изображений                      |
| `rating`            | number?    | Рейтинг                                     |
| `reviewsCount`      | number?    | Количество отзывов                          |

## Задачи

### 1. Создать скрипт экстрактора
- [ ] Файл: `scripts/extractors/pdp.js`
- [ ] Извлечь все поля из таблиц выше
- [ ] Обработать вариации товара
- [ ] Собрать характеристики в объект

### 2. Обработка вариаций
- [ ] Определить тип вариации (размер/цвет/объём)
- [ ] Для каждой опции: значение, статус, селектор
- [ ] Поддержка нескольких групп вариаций (размер + цвет)

### 3. Обработка edge-cases
- [ ] Товар без вариаций
- [ ] Товар "Нет в наличии" (разные UI)
- [ ] Товар с кнопкой "Уведомить о поступлении"
- [ ] Товар для взрослых (18+)
- [ ] Товар в нескольких магазинах (выбор продавца)

### 4. Фильтрация контента
- [ ] Исключить блоки рекламы
- [ ] Исключить "Похожие товары"
- [ ] Исключить "С этим покупают"
- [ ] Исключить отзывы (слишком много текста)
- [ ] Исключить блок вопросов

## Формат результата

```json
{
  "sku": "123456789",
  "title": "Беспроводные наушники Sony WH-1000XM5 с шумоподавлением",
  "brand": "Sony",
  "availability": "inStock",
  "availabilityText": "В наличии, доставка завтра",
  
  "price": 29990,
  "priceOzonCard": 27990,
  "priceOriginal": 35990,
  "discount": 17,
  "currency": "₽",
  
  "variations": [
    {
      "type": "color",
      "name": "Цвет",
      "options": [
        { "value": "Чёрный", "status": "selected", "selector": "[data-option='black']" },
        { "value": "Серебристый", "status": "active", "selector": "[data-option='silver']" },
        { "value": "Синий", "status": "disabled", "selector": "[data-option='blue']" }
      ]
    }
  ],
  
  "specs": {
    "Тип подключения": "Bluetooth 5.2",
    "Время работы": "30 часов",
    "Шумоподавление": "Активное",
    "Вес": "250 г"
  },
  
  "description": "Флагманские наушники с лучшим в классе шумоподавлением...",
  
  "cta": {
    "text": "В корзину",
    "enabled": true,
    "selector": "[data-widget='webAddToCart'] button"
  },
  
  "canonicalUrl": "https://ozon.ru/product/123456789/",
  "imageUrls": ["https://cdn.ozon.ru/..."],
  "rating": 4.8,
  "reviewsCount": 5234
}
```

## Интеграция с MCP

Добавить новый MCP-инструмент:
```javascript
{
  name: "ozon_extract_product",
  description: "Извлечь полную информацию о товаре со страницы карточки Ozon",
  inputSchema: {
    type: "object",
    properties: {
      includeDescription: { type: "boolean", default: true },
      includeSpecs: { type: "boolean", default: true },
      descriptionMaxLength: { type: "number", default: 500 }
    }
  }
}
```

## Acceptance Criteria
- [ ] Работает на страницах `/product/...`
- [ ] Корректно извлекает все вариации со статусами
- [ ] Размер JSON < 5KB (без base64 изображений)
- [ ] Селектор CTA позволяет добавить товар в корзину
- [ ] Характеристики преобразованы в ключ-значение

## Логика выбора вариации для агента

Агент может использовать данные так:
```
1. Проверить availability == "inStock"
2. Найти нужную вариацию: variations.find(v => v.type == "size")
3. Найти нужную опцию: options.find(o => o.value == "L")
4. Если status == "disabled" — попробовать fallback ("XL")
5. Если status == "active" — кликнуть по selector
6. Кликнуть по cta.selector для добавления в корзину
```

## Зависимости
- Story 1 (Stable Selectors)

## Оценка: 8 story points
