# Story 2: Экстрактор данных поисковой выдачи (Listing Page)

## Контекст
Когда LLM-агент выполняет поиск на Ozon, он получает HTML-страницу с 36+ карточками товаров. Передача всего HTML в контекст модели — неэффективна и превышает лимиты токенов. Нужен скрипт-экстрактор.

## Цель
Создать JavaScript-скрипт для извлечения **структурированных данных** из поисковой выдачи Ozon.

## Извлекаемые данные (для каждой карточки)

| Поле              | Тип       | Описание                                      |
|-------------------|-----------|-----------------------------------------------|
| `sku`             | string    | Уникальный идентификатор товара               |
| `title`           | string    | Название товара                               |
| `price`           | number    | Текущая цена                                  |
| `priceOzonCard`   | number?   | Цена с Ozon Картой                            |
| `priceOriginal`   | number?   | Старая цена (зачёркнутая)                     |
| `currency`        | string    | Валюта (₽)                                    |
| `rating`          | number?   | Рейтинг (0-5)                                 |
| `reviewsCount`    | number?   | Количество отзывов                            |
| `delivery`        | string    | Срок доставки ("Завтра", "2-3 дня", ...)      |
| `seller`          | string?   | Имя продавца                                  |
| `url`             | string    | Ссылка на карточку товара                     |
| `imageUrl`        | string?   | URL главного изображения                      |
| `selector`        | string    | CSS-селектор для клика по карточке            |
| `index`           | number    | Порядковый номер в выдаче                     |

## Задачи

### 1. Создать скрипт экстрактора
- [ ] Файл: `scripts/extractors/listing.js`
- [ ] Найти контейнер результатов по `data-widget`
- [ ] Итерировать по карточкам товаров
- [ ] Извлечь все поля из таблицы выше
- [ ] Вернуть массив объектов

### 2. Обработка edge-cases
- [ ] Товар без рейтинга (новый товар)
- [ ] Товар без цены с Ozon Картой
- [ ] Товар "Из-за рубежа" (длительная доставка)
- [ ] Товар "Premium доставка" (badge)
- [ ] Товар с вариациями в листинге
- [ ] Рекламные блоки в выдаче (исключить)

### 3. Оптимизация
- [ ] Ограничить выборку первыми 20 товарами
- [ ] Минимизировать размер возвращаемого JSON
- [ ] Добавить метаданные: `totalResults`, `page`, `query`

## Формат результата

```json
{
  "meta": {
    "query": "наушники беспроводные",
    "totalResults": 1245,
    "page": 1,
    "extractedAt": "2024-12-23T15:30:00Z"
  },
  "products": [
    {
      "index": 1,
      "sku": "123456789",
      "title": "Беспроводные наушники Sony WH-1000XM5",
      "price": 29990,
      "priceOzonCard": 27990,
      "priceOriginal": 35990,
      "currency": "₽",
      "rating": 4.8,
      "reviewsCount": 5234,
      "delivery": "Завтра",
      "seller": "Ozon",
      "url": "/product/besprovodnye-naushniki-sony-123456789/",
      "imageUrl": "https://cdn.ozon.ru/...",
      "selector": "[data-widget='searchResultsV2'] > div:nth-child(1)"
    }
  ]
}
```

## Интеграция с MCP

Добавить новый MCP-инструмент:
```javascript
{
  name: "ozon_extract_listing",
  description: "Извлечь структурированные данные товаров из поисковой выдачи Ozon",
  inputSchema: {
    type: "object",
    properties: {
      limit: { type: "number", default: 20, description: "Максимум товаров" }
    }
  }
}
```

## Acceptance Criteria
- [ ] Скрипт работает на странице `/search/?text=...`
- [ ] Возвращает валидный JSON с массивом товаров
- [ ] Каждый товар имеет уникальный `selector` для клика
- [ ] Размер JSON < 10KB для 20 товаров
- [ ] Нет зависимости от динамических CSS-классов

## Технические заметки
- SKU обычно находится в атрибуте `href` или `data-sku`
- Цены могут быть в формате "29 990 ₽" — нужна очистка
- Использовать `browser_evaluate` для выполнения скрипта

## Зависимости
- Story 1 (Stable Selectors) — нужна карта селекторов

## Оценка: 5 story points
